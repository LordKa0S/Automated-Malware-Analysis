import os
import yara
import logging
log = logging.getLogger(__name__)

SANDBOX_ROOT = r'C:\Users\shantanu.vichare\PycharmProjects\Sandbox'

class Yara:
    def check_yara(self, file_path):
        self.file_path = file_path
        print self.get_yara()

    def get_yara(self, rulepath=os.path.join(SANDBOX_ROOT, "data", "yara", "signatures", "index.yar")):
        """Get Yara signatures matches.
        @return: matched Yara signatures.
        """
        matches = []

        if os.path.getsize(self.file_path) > 0:
            try:
                rules = yara.compile(rulepath)

                for match in rules.match(self.file_path):
                    strings = []
                    for s in match.strings:
                        # Beware, spaghetti code ahead.
                        try:
                            new = s[2].encode("utf-8")
                        except UnicodeDecodeError:
                            s = s[2].lstrip("uU").encode("hex").upper()
                            s = " ".join(s[i:i + 2] for i in range(0, len(s), 2))
                            new = "{ %s }" % s

                        if new not in strings:
                            strings.append(new)

                    matches.append({"name": match.rule,
                                    "meta": match.meta,
                                    "strings": strings})
            except yara.Error as e:
                log.warning("Unable to match Yara signatures: %s", e)

        return matches

yaraObj = Yara()
yaraObj.check_yara(r'C:\Users\shantanu.vichare\PycharmProjects\Sandbox\resources\FirefoxInstaller.exe')